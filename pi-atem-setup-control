#!/bin/bash
set -e

# ==========================================
# ATEM MONITOR AUTO-INSTALLER (v21 - Consistent Flags)
# ==========================================

# 1. DETECT REAL USER
if [ -n "$SUDO_USER" ]; then
    CURRENT_USER="$SUDO_USER"
else
    CURRENT_USER=$(whoami)
fi

if [ "$CURRENT_USER" == "root" ]; then
    echo "âŒ ERROR: Run as normal user (e.g. edgeadmin), not root."
    exit 1
fi

# PATHS
HOME_DIR="/home/$CURRENT_USER"
PROJECT_DIR="$HOME_DIR/atem-monitor-js"
CONTROL_SCRIPT="$HOME_DIR/atem-control.sh"
TRIGGER_SCRIPT="$HOME_DIR/atem-monitor-js/trigger.js"
CONFIG_FILE="$HOME_DIR/atem.config"
SERVICE_FILE="/etc/systemd/system/atem-monitor.service"

# DEFAULT ATEM IP
ATEM_IP="10.1.0.40"
ATEM_SOURCE_DIR="CPC"
LOCAL_DEST_DIR="$HOME_DIR/atem"

echo ">>> Starting Installation for user: $CURRENT_USER"

# 2. INSTALL DEPENDENCIES
sudo apt update
sudo apt install -y nodejs npm lftp swaks

# 3. SETUP DIRECTORIES
mkdir -p "$PROJECT_DIR"
mkdir -p "$LOCAL_DEST_DIR"

# 4. SETUP NODE PROJECT
cd "$PROJECT_DIR"
if [ ! -f "package.json" ]; then npm init -y; fi
npm install atem-connection dotenv

# 5. CREATE CENTRAL CONFIG FILE (If not exists)
if [ -f "$CONFIG_FILE" ]; then
    echo ">>> Config file exists. Preserving settings."
else
    echo ">>> Creating Central Config at $CONFIG_FILE..."
    cat > "$CONFIG_FILE" <<EOF
# ===================================================
# ATEM AUTOMATION CONFIGURATION
# ===================================================

# --- CONNECTION ---
ATEM_IP="10.1.0.40"
ATEM_SOURCE_DIR="CPC"

# --- SUNDAY SCHEDULE (24-Hour Format: HH:MM) ---
ENABLE_AUTO_RECORD="true"
RECORD_START_TIME="09:55"

ENABLE_AUTO_STREAM="true"
STREAM_START_TIME="09:58"

# --- DOWNLOAD & NOTIFICATION ---
ENABLE_DOWNLOAD="true"
ENABLE_EMAIL="true"

# --- EMAIL SETTINGS ---
SMTP_SERVER="smtp.gmail.com"
SMTP_PORT="587"
SMTP_USER="your_email@gmail.com"
SMTP_PASS="your_app_password"

# "From" Address (Must match SMTP User usually)
EMAIL_FROM="your_email@gmail.com"

# "From" Name (The friendly name shown in inbox)
EMAIL_FROM_NAME="ATEM Monitor"

# Recipients (Comma separated)
EMAIL_TO="your_email@gmail.com, second_email@gmail.com"

EMAIL_SUBJECT_PREFIX="[ATEM-Pi]"
EOF
    chown "$CURRENT_USER:$CURRENT_USER" "$CONFIG_FILE"
    chmod 600 "$CONFIG_FILE"
fi

# 6. CREATE TRIGGER.JS (The "Hitman" Script)
cat > "$TRIGGER_SCRIPT" <<EOF
const { Atem } = require('atem-connection');
const fs = require('fs');

// Load Config
const configPath = '$CONFIG_FILE';
const config = {};
try {
    const fileContent = fs.readFileSync(configPath, 'utf8');
    fileContent.split('\n').forEach(line => {
        const match = line.match(/^\s*([A-Z_]+)=["']?(.*?)["']?\s*$/);
        if (match) config[match[1]] = match[2];
    });
} catch (e) { console.error('Config Error:', e); process.exit(1); }

const ATEM_IP = config.ATEM_IP || '$ATEM_IP';
const command = process.argv[2]; 

console.log(\`ðŸ”Œ Connecting to ATEM at \${ATEM_IP}...\`);
const myAtem = new Atem();

myAtem.on('connected', async () => {
    console.log('âœ… Connected.');
    try {
        if (command === 'record') {
            console.log('ðŸ”´ Sending START RECORDING command...');
            await myAtem.startRecording();
            console.log('âœ… Command Sent.');
        } else if (command === 'stream') {
            console.log('ðŸ“¡ Sending START STREAMING command...');
            await myAtem.startStreaming();
            console.log('âœ… Command Sent.');
        } else {
            console.log('âŒ Unknown command.');
        }
    } catch (e) {
        console.error('âŒ Error sending command:', e);
    }
    setTimeout(() => {
        myAtem.disconnect();
        process.exit(0);
    }, 500);
});

myAtem.on('error', (e) => {
    console.error('âŒ Connection Error:', e);
    process.exit(1);
});

myAtem.connect(ATEM_IP);
EOF

# 7. CREATE MONITOR.JS (The Watchdog)
cat > "$PROJECT_DIR/monitor.js" <<EOF
const { Atem } = require('atem-connection');
const { exec } = require('child_process');
const fs = require('fs');

const configPath = '$CONFIG_FILE';
const config = {};
function loadConfig() {
    try {
        const fileContent = fs.readFileSync(configPath, 'utf8');
        fileContent.split('\n').forEach(line => {
            const match = line.match(/^\s*([A-Z_]+)=["']?(.*?)["']?\s*$/);
            if (match) config[match[1]] = match[2];
        });
    } catch (e) { console.error('Config Load Error'); }
}
loadConfig();

const ATEM_IP = config.ATEM_IP || '$ATEM_IP';
const SCRIPT_TO_RUN = '$CONTROL_SCRIPT';

console.log('-------------------------------------');
console.log('ðŸ“¡ ATEM MONITOR STARTED');
console.log('-------------------------------------');

const myAtem = new Atem();
let wasRecording = false;
let recordTriggered = false;
let streamTriggered = false;

myAtem.on('connected', () => {
    console.log(\`âœ… Connected to ATEM\`);
    if (myAtem.state && myAtem.state.recording && myAtem.state.recording.status) {
        wasRecording = myAtem.state.recording.status.state === 1; 
    }
});

myAtem.on('stateChanged', (state, pathToChange) => {
    if (pathToChange.some(path => path.includes('recording.status'))) {
        const isRecording = state.recording.status.state === 1;
        if (wasRecording !== isRecording) {
            if (isRecording) {
                console.log('ðŸ”´ RECORDING STARTED');
            } else {
                console.log('â¬œ RECORDING STOPPED -> Triggering Download...');
                exec(\`\${SCRIPT_TO_RUN}\`, (error, stdout, stderr) => {
                    if (stdout) console.log(stdout.trim());
                });
            }
            wasRecording = isRecording;
        }
    }
});

// SCHEDULER
setInterval(() => {
    loadConfig(); 
    const now = new Date();
    const day = now.getDay(); 
    const currentTime = \`\${String(now.getHours()).padStart(2, '0')}:\${String(now.getMinutes()).padStart(2, '0')}\`;

    if (currentTime === '00:00') { recordTriggered = false; streamTriggered = false; }
    if (day !== 0) return;

    if (config.ENABLE_AUTO_RECORD === 'true' && currentTime === config.RECORD_START_TIME && !recordTriggered) {
        recordTriggered = true;
        console.log('â° TRIGGER: Auto-Record');
        myAtem.startRecording().catch(console.error);
    }
    if (config.ENABLE_AUTO_STREAM === 'true' && currentTime === config.STREAM_START_TIME && !streamTriggered) {
        streamTriggered = true;
        console.log('â° TRIGGER: Auto-Stream');
        myAtem.startStreaming().catch(console.error);
    }
}, 10000);

myAtem.connect(ATEM_IP);
EOF

# 8. CREATE CONTROL SCRIPT (Updated Flag Name)
echo ">>> Creating Control Script at $CONTROL_SCRIPT..."
cat > "$CONTROL_SCRIPT" <<EOF
#!/bin/bash

# LOAD SHARED CONFIGURATION
CONFIG_FILE="$CONFIG_FILE"
if [ -f "\$CONFIG_FILE" ]; then source "\$CONFIG_FILE"; else exit 1; fi

# ===================================================
# HELPERS
# ===================================================
LOG_BUFFER=""
log() { echo "\$1"; LOG_BUFFER+="\${1}\n"; }

send_notification() {
    if [ "\$ENABLE_EMAIL" != "true" ]; then echo "ðŸ“§ Email Disabled."; return; fi
    STATUS="\$1"
    BODY="\${2:-\$LOG_BUFFER}" 
    if [[ "\$SMTP_USER" == *"your_email"* ]]; then echo "âš ï¸ Email not configured."; return; fi
    
    # CONSTRUCT HEADER
    if [[ -n "\${EMAIL_FROM_NAME:-}" ]]; then
        FROM_HEADER="From: \$EMAIL_FROM_NAME <\$EMAIL_FROM>"
    else
        FROM_HEADER="From: \$EMAIL_FROM"
    fi

    echo "ðŸ“§ Sending Email (\$STATUS)..."
    swaks --to "\$EMAIL_TO" \
          --from "\$EMAIL_FROM" \
          --header "\$FROM_HEADER" \
          --server "\$SMTP_SERVER" --port "\$SMTP_PORT" \
          --auth LOGIN --auth-user "\$SMTP_USER" --auth-password "\$SMTP_PASS" --tls \
          --header "Subject: \$EMAIL_SUBJECT_PREFIX \$STATUS" --body "\$BODY" --hide-all
    
    if [ \$? -eq 0 ]; then echo "âœ… Email Sent."; else echo "âŒ Email Failed."; fi
}
die() { log "âŒ FATAL: \$1"; send_notification "FAILED"; exit 1; }

# ===================================================
# FLAGS
# ===================================================
if [[ "\${1:-}" == "--test-email" ]]; then
    echo "ðŸ§ª RUNNING EMAIL TEST..."
    ENABLE_EMAIL="true" 
    send_notification "TEST SUCCESS" "This is a test email.\nSMTP settings are correct!"
    exit 0
fi

if [[ "\${1:-}" == "--test-record" ]]; then
    echo "ðŸ§ª TRIGGERING ATEM RECORDING..."
    /usr/bin/node "$TRIGGER_SCRIPT" record
    exit 0
fi

if [[ "\${1:-}" == "--test-stream" ]]; then
    echo "ðŸ§ª TRIGGERING ATEM STREAM..."
    /usr/bin/node "$TRIGGER_SCRIPT" stream
    exit 0
fi

ON_DEMAND_MODE=false
if [[ "\${1:-}" == "--on-demand" ]]; then
    ON_DEMAND_MODE=true
    echo "ðŸ› ï¸ ON-DEMAND MODE ACTIVE: Bypassing time checks."
fi

# ===================================================
# MAIN DOWNLOAD LOGIC
# ===================================================
if [ "\$ENABLE_DOWNLOAD" != "true" ] && [ "\$ON_DEMAND_MODE" = false ]; then
    echo "ðŸš« Downloads Disabled in Config. Exiting."
    exit 0
fi

CURRENT_DAY=\$(date +%u)
CURRENT_HOUR=\$(date +%H)
if [ "\$ON_DEMAND_MODE" = false ]; then
    if [ "\$CURRENT_DAY" -ne 7 ]; then echo "â³ Not Sunday. Skipping."; exit 0; fi
    if [ "\$CURRENT_HOUR" -lt 11 ]; then echo "â³ Before 11AM. Skipping."; exit 0; fi
fi

log "â³ Waiting 5 seconds..."
sleep 5
set -u 
DEST_DIR="$LOCAL_DEST_DIR"
TIMEOUT=5

# Checks
if ! command -v lftp >/dev/null 2>&1; then die "lftp missing."; fi
mkdir -p "\$DEST_DIR"
if ! ping -c 1 -W 1 "\$ATEM_IP" >/dev/null 2>&1; then die "ATEM unreachable."; fi

# List files
log "ðŸ“‚ Listing files..."
RAW_LIST=\$(lftp -c "set net:max-retries 1; set net:timeout \$TIMEOUT; open ftp://anonymous:@\$ATEM_IP; cd \$ATEM_SOURCE_DIR; cls --long --time-style=long-iso") || die "FTP Error"
if [[ -z "\$RAW_LIST" ]]; then die "No files returned."; fi

# Parse List
TMP_LIST=\$(echo "\$RAW_LIST" | awk '{
    date_idx = 0
    for (i=1; i<=NF; i++) { if (\$i ~ /^[0-9]{4}-[0-9]{2}-[0-9]{2}\$/) { date_idx = i; break } }
    if (date_idx == 0) next 
    date = \$date_idx
    name_start = date_idx + 2
    name = ""
    for (i=name_start; i<=NF; i++) { name = name \$i " " }
    sub(/ \$/, "", name)

    if (name == "") next
    if (tolower(name) !~ /\.mp4\$/) next
    if (name ~ /^\._/) next 

    print date "|" name
}')

if [[ -z "\$TMP_LIST" ]]; then die "No .mp4 files found."; fi

# Latest
LATEST_DATE=\$(echo "\$TMP_LIST" | cut -d'|' -f1 | sort -u | tail -n 1)
if [[ -z "\$LATEST_DATE" ]]; then die "No date found."; fi
log "ðŸ“… Latest Date: \$LATEST_DATE"
LATEST_MP4=\$(echo "\$TMP_LIST" | awk -F'|' -v d="\$LATEST_DATE" '\$1==d {print \$2}' | sort)

# Download
FILE_PREFIX=\$(date -d "\$LATEST_DATE" +"%Y-%m%d")
COUNT=1
log "â¬‡ï¸  Downloading..."
while IFS= read -r file; do
    NEW_NAME="\${FILE_PREFIX}-\${COUNT}.mp4"
    LOCAL_PATH="\$DEST_DIR/\$NEW_NAME"
    if [ -f "\$LOCAL_PATH" ]; then
        log "   âš ï¸ Exists: \$NEW_NAME"
    else
        log "   âž¡ï¸  \$file -> \$NEW_NAME"
        lftp -c "set net:timeout \$TIMEOUT; open ftp://anonymous:@\$ATEM_IP; cd \$ATEM_SOURCE_DIR; get \"\$file\" -o \"\$LOCAL_PATH\"" || die "Download failed"
        log "   âœ… Saved."
    fi
    COUNT=\$((COUNT+1))
done <<< "\$LATEST_MP4"

log "ðŸŽ‰ Complete."
send_notification "SUCCESS"
EOF

# 9. FIX PERMISSIONS
chown -R "$CURRENT_USER:$CURRENT_USER" "$PROJECT_DIR"
chown "$CURRENT_USER:$CURRENT_USER" "$CONTROL_SCRIPT"
chown "$CURRENT_USER:$CURRENT_USER" "$TRIGGER_SCRIPT"
chown "$CURRENT_USER:$CURRENT_USER" "$CONFIG_FILE"
chmod 700 "$CONTROL_SCRIPT"

# 10. RESTART SERVICE
sudo bash -c "cat > $SERVICE_FILE" <<EOF
[Unit]
Description=ATEM Automation System
After=network-online.target
Wants=network-online.target
[Service]
User=$CURRENT_USER
WorkingDirectory=$PROJECT_DIR
ExecStart=/usr/bin/node monitor.js
Restart=always
RestartSec=5
[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable atem-monitor
sudo systemctl restart atem-monitor

echo "================================================="
echo "âœ… UPDATED TO v21 (Consistent Flags)"
echo "   New Testing Commands:"
echo "   ~/atem-control.sh --test-email"
echo "   ~/atem-control.sh --test-record"
echo "   ~/atem-control.sh --test-stream"
echo "================================================="
